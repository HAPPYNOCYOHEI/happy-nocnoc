{%- liquid
  assign badge_position = settings.badge_position

  # Custom badges
  assign product_tags = product_card_product.tags
  assign badge_tags_1 = settings.custom_product_badge_group_1_tag_names | split: ', '
  assign badge_tags_2 = settings.custom_product_badge_group_2_tag_names | split: ', '
  assign badge_tags_3 = settings.custom_product_badge_group_3_tag_names | split: ', '
  assign badge_tags_4 = settings.custom_product_badge_group_4_tag_names | split: ', '
  assign badge_tags = badge_tags_1 | concat: badge_tags_2 | concat: badge_tags_3 | concat: badge_tags_4
-%}
{%- for badge_tag in badge_tags -%}
  {%- for product_tag in product_tags -%}
    {%- assign product_tag_lower = product_tag | downcase -%}
    {%- assign badge_tag_lower = badge_tag | downcase -%}
    {%- if product_tag_lower == badge_tag_lower -%}
      {%- capture custom_badges -%}
				{{ custom_badges }}
				<div class="badge {{ badge_tag_lower | handleize }}" data-badge="{{ badge_tag_lower | handleize }}">
					{{ badge_tag }}
				</div>
			{%- endcapture -%}
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}
<span class="product-card--badges {{ badge_position }}">
  {%- unless product_card_product.available -%}
    <span class="badge out-of-stock">{{ 'products.product.sold_out' | t }}</span>
  {%- endunless -%}
  {% comment %} 注释 {%- if product_card_product.compare_at_price > product_card_product.price and product_card_product.available -%}
    {%- if settings.sale_badge_type == 'save_amount' -%}
      {%- capture saved_amount -%}{{ product_card_product.compare_at_price | minus: product_card_product.price | money }}{%- endcapture -%}
    {%- elsif settings.sale_badge_type == 'save_percentage' -%}
      {%- capture saved_amount -%}{{ product_card_product.compare_at_price | minus: product_card_product.price | times: 100.0 | divided_by: product_card_product.compare_at_price | round }}%{%- endcapture -%}
    {%- endif -%}
    <span class="badge onsale">
      {%- if settings.sale_badge_type == 'sale' -%}
        {{ 'products.product.on_sale' | t }}
      {%- else -%}
        {{ 'products.product.save_html' | t: saved_amount: saved_amount }}
      {%- endif -%}
    </span>
  {%- endif -%} {% endcomment %}
   
{%- if product_card_product.compare_at_price > product_card_product.price and product_card_product.available -%}
  {%- if settings.sale_badge_type == 'save_amount' -%}
    {%- capture saved_amount -%}{{ product_card_product.compare_at_price | minus: product_card_product.price | money }}{%- endcapture -%}
  {%- elsif settings.sale_badge_type == 'save_percentage' -%}
    {%- comment %} 1. 计算原始百分比（和原始代码逻辑完全一致） {% endcomment %}
    {%- assign discount_diff = product_card_product.compare_at_price | minus: product_card_product.price -%}
    {%- assign raw_percentage = discount_diff | times: 100.0 | divided_by: product_card_product.compare_at_price | round -%}

    {%- comment %} 2. 开关开启时才执行归整，关闭时直接用原始值 {% endcomment %}
    {%- if settings.enable_discount_round_to_ten -%}
      {%- assign units_digit = raw_percentage | modulo: 10 -%}
      {%- if units_digit == 0 or units_digit == 1 or units_digit == 2 or units_digit == 8 or units_digit == 9 -%}
        {%- assign rounded_percentage = raw_percentage | divided_by: 10.0 | round | times: 10 -%}
      {%- else -%}
        {%- assign rounded_percentage = raw_percentage -%}
      {%- endif -%}
      {%- capture saved_amount -%}{{ rounded_percentage }}%{%- endcapture -%}
    {%- else -%}
      {%- comment %} 开关关闭：直接使用原始计算结果（和原始代码完全一致） {% endcomment %}
      {%- capture saved_amount -%}{{ raw_percentage }}%{%- endcapture -%}
    {%- endif -%}
  {%- endif -%}

  <span class="badge onsale">
    {%- if settings.sale_badge_type == 'sale' -%}
      {{ 'products.product.on_sale' | t }}
    {%- else -%}
      {{ 'products.product.save_html' | t: saved_amount: saved_amount }}
    {%- endif -%}
  </span>
{%- endif -%}

  {%- if product_card_product.metafields.custom.preorder and product_card_product.available -%}
    <span class="badge pre-order">
      {{ 'products.product.pre_order' | t }}
    </span>
  {%- endif -%}
  {{ custom_badges }}
</span>
